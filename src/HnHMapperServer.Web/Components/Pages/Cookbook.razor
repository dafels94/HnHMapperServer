@page "/cookbook"
@rendermode InteractiveServer
@using HnHMapperServer.Core.DTOs
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using HnHMapperServer.Web.Helpers
@using System.Text.Json
@implements IDisposable
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Cookbook - HnH Mapper</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Food Cookbook</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">
        Browse and search Haven & Hearth recipes. Click on a recipe to view details and calculate FEPs.
    </MudText>

    @* ========== ADVANCED SEARCH SECTION ========== *@
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-2" />
            Advanced Search
        </MudText>
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="searchTerm"
                              Label="Search recipes"
                              Variant="Variant.Outlined"
                              Immediate="true"
                              Clearable="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="ingredientFilter"
                              Label="Filter by ingredient"
                              Variant="Variant.Outlined"
                              Immediate="true"
                              Clearable="true" />
            </MudItem>
            <MudItem xs="12" md="5">
                <MudSelect T="string"
                           Value="fepFilter"
                           ValueChanged="OnFepFilterChanged"
                           Label="Filter by FEP type"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    <MudSelectItem Value="@("STR")">Strength (STR)</MudSelectItem>
                    <MudSelectItem Value="@("CON")">Constitution (CON)</MudSelectItem>
                    <MudSelectItem Value="@("AGI")">Agility (AGI)</MudSelectItem>
                    <MudSelectItem Value="@("INT")">Intelligence (INT)</MudSelectItem>
                    <MudSelectItem Value="@("CHA")">Charisma (CHA)</MudSelectItem>
                    <MudSelectItem Value="@("DEX")">Dexterity (DEX)</MudSelectItem>
                    <MudSelectItem Value="@("WILL")">Will (WILL)</MudSelectItem>
                    <MudSelectItem Value="@("PSY")">Psyche (PSY)</MudSelectItem>
                    <MudSelectItem Value="@("PER")">Perception (PER)</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>

        <MudExpansionPanels Class="mt-2">
            <MudExpansionPanel Text="Advanced Filters">
                <MudGrid>
                    <MudItem xs="12" md="3">
                        <MudSelect @bind-Value="tierFilter"
                                   Label="Filter by Tier"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            <MudSelectItem Value="@("Best")">Best</MudSelectItem>
                            <MudSelectItem Value="@("Mid")">Mid</MudSelectItem>
                            <MudSelectItem Value="@("Low")">Low</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="minPurity"
                                        Label="Min Purity %"
                                        Variant="Variant.Outlined"
                                        Min="0"
                                        Max="100"
                                        Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="minEfficiency"
                                        Label="Min Efficiency"
                                        Variant="Variant.Outlined"
                                        Min="0"
                                        Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="maxHunger"
                                        Label="Max Hunger"
                                        Variant="Variant.Outlined"
                                        Min="0"
                                        Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect @bind-Value="sortBy"
                                   Label="Sort By"
                                   Variant="Variant.Outlined">
                            <MudSelectItem Value="@("Efficiency")">Efficiency (Best First)</MudSelectItem>
                            <MudSelectItem Value="@("Purity")">Purity (Cleanest First)</MudSelectItem>
                            <MudSelectItem Value="@("PowerScore")">Power Score</MudSelectItem>
                            <MudSelectItem Value="@("Tier")">Tier</MudSelectItem>
                            <MudSelectItem Value="@("Name")">Name (A-Z)</MudSelectItem>
                            <MudSelectItem Value="@("Hunger")">Hunger (Lowest First)</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>

        <MudGrid Class="mt-2">
            <MudItem xs="12">
                <MudCheckBox @bind-Value="includeGlobal" Label="Show global recipes" Color="Color.Primary" />
                <MudCheckBox @bind-Value="includeTenant" Label="Show tenant recipes" Color="Color.Primary" Class="ml-4" />
            </MudItem>
        </MudGrid>

        @* ========== SEARCH RESULTS (inside Advanced Search paper) ========== *@
        <MudDivider Class="my-4" />

        @if (loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (allGroups.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No recipes found. Try adjusting your search filters.</MudAlert>
        }
        else
        {
            <MudText Typo="Typo.subtitle1" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Restaurant" Class="mr-1" Size="Size.Small" />
                Found @allGroups.Count recipe group(s) (@totalCount total variants)
            </MudText>

            <MudExpansionPanels Elevation="1" Class="mt-2">
                @foreach (var group in GetPagedGroups())
                {
                    <FoodGroupPanel Group="@group" OnViewRecipe="ViewRecipe" />
                }
            </MudExpansionPanels>

            @if (allGroups.Count > groupsPerPage)
            {
                <MudPagination Class="mt-4"
                              Count="@((int)Math.Ceiling(allGroups.Count / (double)groupsPerPage))"
                              Selected="@currentPage"
                              SelectedChanged="OnPageChanged" />
            }
        }
    </MudPaper>

    @* ========== FEAST PLANNER SECTION ========== *@
    <FeastPlannerSection />

    @* ========== ROLE OVERVIEW SECTION ========== *@
    <MudPaper Class="pa-4 mb-4" Elevation="3">
        <MudText Typo="Typo.h5" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Group" Class="mr-2" />
            Top Foods by Role
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Secondary">
            Best foods for your character's specialization
        </MudText>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2">
            <MudTabPanel Text="Fighter" Icon="@Icons.Material.Filled.Shield">
                <RoleOverviewSection Role="Fighter" Limit="20" />
            </MudTabPanel>
            <MudTabPanel Text="Crafter" Icon="@Icons.Material.Filled.Construction">
                <RoleOverviewSection Role="Crafter" Limit="20" />
            </MudTabPanel>
            <MudTabPanel Text="Universal" Icon="@Icons.Material.Filled.AutoAwesome">
                <RoleOverviewSection Role="Universal" Limit="20" />
            </MudTabPanel>
        </MudTabs>
    </MudPaper>

    @* ========== STAT OVERVIEW SECTION ========== *@
    <MudPaper Class="pa-4 mb-4" Elevation="3">
        <MudText Typo="Typo.h5" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Leaderboard" Class="mr-2" />
            Stat Research
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Secondary">
            Find the best foods for each stat - expand to see full ranked lists, tier breakdown, and search
        </MudText>

        <MudExpansionPanels MultiExpansion="true" Elevation="1">
            @foreach (var stat in allStats)
            {
                <StatResearchPanel Stat="@stat" />
            }
        </MudExpansionPanels>
    </MudPaper>
</MudContainer>

@code {
    // All stats for overview cards
    private readonly string[] allStats = new[] { "STR", "AGI", "CON", "INT", "CHA", "DEX", "WILL", "PSY", "PER" };

    private List<FoodDto> foods = new();
    private List<GroupedFoodDto> allGroups = new();  // All groups (complete)
    private int totalCount = 0;
    private bool loading = true;

    private string _searchTerm = "";
    private string searchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                _ = DebouncedSearch();
            }
        }
    }

    private string _ingredientFilter = "";
    private string ingredientFilter
    {
        get => _ingredientFilter;
        set
        {
            if (_ingredientFilter != value)
            {
                _ingredientFilter = value;
                _ = DebouncedSearch();
            }
        }
    }

    private string? fepFilter = null;
    private bool includeGlobal = true;
    private bool includeTenant = true;

    // Advanced filters
    private string? tierFilter = null;
    private decimal? minPurity = null;
    private decimal? minEfficiency = null;
    private int? maxHunger = null;
    private string sortBy = "Efficiency";

    private int currentPage = 1;
    private int groupsPerPage = 20;  // Groups per page (not individual foods)

    // Debounce timer and search tracking
    private CancellationTokenSource? _debounceTokenSource;
    private int _searchId = 0;
    private const int DebounceDelayMs = 300;

    protected override async Task OnInitializedAsync()
    {
        await SearchFoods();
    }

    private async Task DebouncedSearch()
    {
        // Cancel any pending debounce
        _debounceTokenSource?.Cancel();
        _debounceTokenSource = new CancellationTokenSource();
        var token = _debounceTokenSource.Token;

        try
        {
            // Wait for debounce delay
            await Task.Delay(DebounceDelayMs, token);

            // If not cancelled, perform search
            if (!token.IsCancellationRequested)
            {
                currentPage = 1;
                await SearchFoods();
            }
        }
        catch (TaskCanceledException)
        {
            // Ignore - this is expected when user types quickly
        }
    }

    public void Dispose()
    {
        _debounceTokenSource?.Cancel();
        _debounceTokenSource?.Dispose();
    }

    private async Task SearchFoods()
    {
        // Increment search ID to track this specific search
        var mySearchId = ++_searchId;

        loading = true;
        StateHasChanged();

        try
        {
            var currentSearchTerm = _searchTerm;  // Capture current value
            var currentIngredient = _ingredientFilter;

            var searchDto = new FoodSearchDto
            {
                SearchTerm = string.IsNullOrWhiteSpace(currentSearchTerm) ? null : currentSearchTerm,
                Ingredient = string.IsNullOrWhiteSpace(currentIngredient) ? null : currentIngredient,
                FepType = fepFilter,
                IncludeGlobal = includeGlobal,
                IncludeTenant = includeTenant,
                Skip = 0,      // Always fetch from start - pagination is client-side by groups
                Take = 2000,   // Fetch enough to get complete groups
                // Advanced filters
                Tier = tierFilter,
                MinPurity = minPurity.HasValue ? minPurity.Value / 100m : null,  // Convert % to decimal
                MinEfficiency = minEfficiency,
                MaxHunger = maxHunger,
                SortBy = sortBy,
                SortDescending = true
            };

            var http = HttpClientFactory.CreateClient("API");
            var response = await http.PostAsJsonAsync("/api/foods/search", searchDto);

            // Check if this search is still the latest one - ignore stale results
            if (mySearchId != _searchId)
                return;

            if (response.IsSuccessStatusCode)
            {
                var jsonOptions = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var result = await response.Content.ReadFromJsonAsync<SearchResult>(jsonOptions);

                if (result != null && mySearchId == _searchId)
                {
                    foods = result.Foods.ToList();
                    totalCount = result.TotalCount;
                    // Create all groups from fetched foods
                    allGroups = CreateGroupedFoods();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching foods: {ex.Message}");
        }
        finally
        {
            // Only update loading state if this is still the current search
            if (mySearchId == _searchId)
            {
                loading = false;
                StateHasChanged();
            }
        }
    }

    private async Task OnFepFilterChanged(string? value)
    {
        fepFilter = value;
        currentPage = 1;
        await SearchFoods();
    }

    private void OnPageChanged(int page)
    {
        currentPage = page;
        StateHasChanged();  // Just re-render, no re-fetch needed
    }

    private void ViewRecipe(int id)
    {
        Navigation.NavigateTo($"/cookbook/{id}");
    }

    private List<GroupedFoodDto> CreateGroupedFoods()
    {
        if (foods == null || !foods.Any())
            return new List<GroupedFoodDto>();

        return foods
            .GroupBy(f => $"{f.Name}{(f.IsSmoked ? " (Smoked)" : "")}")
            .Select(g => new GroupedFoodDto
            {
                FoodName = g.Key,
                AllVariants = g.ToList(),
                VariantCount = g.Count(),
                BestVariant = g.OrderByDescending(f => FoodHelpers.CalculateTierAdjustedEfficiency(f)).First()
            })
            .ToList();
    }

    private List<GroupedFoodDto> GetPagedGroups()
    {
        return allGroups
            .Skip((currentPage - 1) * groupsPerPage)
            .Take(groupsPerPage)
            .ToList();
    }

    private class SearchResult
    {
        public List<FoodDto> Foods { get; set; } = new();
        public int TotalCount { get; set; }
    }
}
