@using HnHMapperServer.Core.DTOs
@using System.Net.Http.Json
@using HnHMapperServer.Web.Helpers
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudStack Spacing="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudIcon Icon="@GetRoleIcon(Role)" Size="Size.Large" Color="@GetRoleColor(Role)" />
                <div>
                    <MudText Typo="Typo.h5">@Role Foods</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@GetRoleDescription(Role)</MudText>
                </div>
            </MudStack>
            @if (!loading && topFoods != null && topFoods.Count > 0)
            {
                var totalVariants = topFoods.Sum(g => g.VariantCount);
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Showing @topFoods.Count food groups (@totalVariants variants)
                </MudText>
            }
        </MudStack>

        @if (loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (topFoods == null || topFoods.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No @Role foods found in the cookbook.</MudAlert>
        }
        else
        {
            <MudExpansionPanels Elevation="0" Class="seamless-panels">
                @foreach (var group in topFoods)
                {
                    <FoodGroupPanel Group="@group" OnViewRecipe="ViewRecipe" />
                }
            </MudExpansionPanels>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public string Role { get; set; } = "Fighter";

    [Parameter]
    public int Limit { get; set; } = 20;

    private List<GroupedFoodDto>? topFoods = null;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadTopFoods();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadTopFoods();
    }

    private async Task LoadTopFoods()
    {
        loading = true;
        StateHasChanged();

        try
        {
            var http = HttpClientFactory.CreateClient("API");
            var response = await http.GetAsync($"/api/foods/top-by-role/{Role}?limit={Limit}");

            if (response.IsSuccessStatusCode)
            {
                topFoods = await response.Content.ReadFromJsonAsync<List<GroupedFoodDto>>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading top foods for {Role}: {ex.Message}");
            topFoods = new List<GroupedFoodDto>();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private IEnumerable<FoodDto> GetAllVariants()
    {
        if (topFoods == null || !topFoods.Any())
            return Enumerable.Empty<FoodDto>();

        // Flatten all variants from all groups
        return topFoods
            .SelectMany(group => group.AllVariants)
            .ToList();
    }

    private string GetRoleDescription(string role)
    {
        return role switch
        {
            "Fighter" => "Emphasizes STR, AGI, CON - for combat excellence",
            "Crafter" => "Emphasizes PSY, DEX, WILL - for crafting mastery",
            "Universal" => "Balanced 40-60% split - versatile for all roles",
            _ => ""
        };
    }

    private string GetRoleIcon(string role)
    {
        return role switch
        {
            "Fighter" => Icons.Material.Filled.Shield,
            "Crafter" => Icons.Material.Filled.Construction,
            "Universal" => Icons.Material.Filled.AutoAwesome,
            _ => Icons.Material.Filled.Circle
        };
    }

    private Color GetRoleColor(string role)
    {
        return role switch
        {
            "Fighter" => Color.Error,
            "Crafter" => Color.Info,
            "Universal" => Color.Success,
            _ => Color.Default
        };
    }

    private void ViewRecipe(int id)
    {
        Navigation.NavigateTo($"/cookbook/{id}");
    }
}
