@using HnHMapperServer.Core.DTOs
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory

<MudCard Elevation="2" Class="stat-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@GetStatIcon(Stat)" Size="Size.Small" Class="mr-2" />
                @GetStatName(Stat)
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        @if (loading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
        }
        else if (topFoods == null || topFoods.Count == 0)
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary">No foods found</MudText>
        }
        else
        {
            @* Champion (#1) *@
            @if (topFoods.Count > 0)
            {
                var champion = topFoods[0];
                <MudPaper Elevation="1" Class="pa-3 mb-2 champion-card">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="1">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5" Class="gold-medal">ðŸ¥‡</MudText>
                                <MudText Typo="Typo.body1"><strong>@champion.Name</strong></MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Stat Value: @champion.StatValue.ToString("F1") | Efficiency: @champion.Efficiency.ToString("F1")
                            </MudText>
                        </MudStack>
                        <MudChip T="string" Size="Size.Small" Color="@GetTierColor(champion.Tier)">
                            @champion.Tier
                        </MudChip>
                    </MudStack>
                </MudPaper>
            }

            @* Podium (#2, #3) *@
            <MudStack Spacing="1" Class="mt-2">
                @if (topFoods.Count > 1)
                {
                    var runner = topFoods[1];
                    <MudPaper Elevation="0" Class="pa-2 podium-card">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2">ðŸ¥ˆ</MudText>
                                <MudText Typo="Typo.body2">@runner.Name</MudText>
                            </MudStack>
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@runner.StatValue.ToString("F1")</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetTierColor(runner.Tier)">@runner.Tier</MudChip>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }

                @if (topFoods.Count > 2)
                {
                    var third = topFoods[2];
                    <MudPaper Elevation="0" Class="pa-2 podium-card">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2">ðŸ¥‰</MudText>
                                <MudText Typo="Typo.body2">@third.Name</MudText>
                            </MudStack>
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@third.StatValue.ToString("F1")</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetTierColor(third.Tier)">@third.Tier</MudChip>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public string Stat { get; set; } = "STR";

    private List<FoodDto>? topFoods = null;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadTopFoods();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadTopFoods();
    }

    private async Task LoadTopFoods()
    {
        loading = true;
        StateHasChanged();

        try
        {
            var http = HttpClientFactory.CreateClient("API");
            var response = await http.GetAsync($"/api/foods/top-by-stat/{Stat}?limit=3");

            if (response.IsSuccessStatusCode)
            {
                topFoods = await response.Content.ReadFromJsonAsync<List<FoodDto>>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading top foods for {Stat}: {ex.Message}");
            topFoods = new List<FoodDto>();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private string GetStatName(string stat)
    {
        return stat.ToUpper() switch
        {
            "STR" => "Strength",
            "AGI" => "Agility",
            "CON" => "Constitution",
            "INT" => "Intelligence",
            "CHA" => "Charisma",
            "DEX" => "Dexterity",
            "WILL" => "Will",
            "PSY" => "Psyche",
            "PER" => "Perception",
            _ => stat
        };
    }

    private string GetStatIcon(string stat)
    {
        return stat.ToUpper() switch
        {
            "STR" => Icons.Material.Filled.FitnessCenter,
            "AGI" => Icons.Material.Filled.DirectionsRun,
            "CON" => Icons.Material.Filled.Favorite,
            "INT" => Icons.Material.Filled.Psychology,
            "CHA" => Icons.Material.Filled.EmojiEmotions,
            "DEX" => Icons.Material.Filled.PanTool,
            "WILL" => Icons.Material.Filled.Shield,
            "PSY" => Icons.Material.Filled.AutoAwesome,
            "PER" => Icons.Material.Filled.Visibility,
            _ => Icons.Material.Filled.Circle
        };
    }

    private Color GetTierColor(string tier)
    {
        return tier switch
        {
            "Best" => Color.Success,
            "Mid" => Color.Warning,
            "Low" => Color.Default,
            _ => Color.Default
        };
    }
}
